<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE Stream AI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #response {
            white-space: pre-wrap;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 20px;
            height: 300px;
            overflow-y: auto;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>SSE Stream AI</h1>

    <form id="aiForm">
        <label for="prompt">Enter your question:</label><br>
        <textarea id="prompt" name="prompt" rows="4" cols="50" required></textarea><br><br>

        <label for="emotions">Choose emotions (comma-separated):</label><br>
        <input type="text" id="emotions" name="emotions" placeholder="e.g., 기쁨이, 슬픔이" required><br><br>

        <button type="submit">Ask AI</button>
    </form>

    <h2>Responses:</h2>
    <div id="response">Waiting for response...</div>

    <script>
        document.getElementById("aiForm").addEventListener("submit", function (event) {
            event.preventDefault();

            const prompt = document.getElementById("prompt").value;
            const emotions = document.getElementById("emotions").value.split(",").map(e => e.trim());

            // POST 요청 생성
            fetch("/api/ai/ask-ai", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    prompt: prompt,
                    emotions: emotions,
                }),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.body.getReader();
                })
                .then((reader) => {
                    const responseDiv = document.getElementById("response");
                    responseDiv.textContent = ""; // Clear previous responses
                    const decoder = new TextDecoder("utf-8");

                    function read() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                responseDiv.textContent += "\n[Stream Ended]";
                                return;
                            }
                            const chunk = decoder.decode(value, { stream: true });
                            responseDiv.textContent += chunk;
                            responseDiv.scrollTop = responseDiv.scrollHeight; // Scroll to bottom
                            read();
                        });
                    }
                    read();
                })
                .catch((error) => {
                    console.error("Error in SSE connection:", error);
                });
        });
    </script>
</body>
</html>
